name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (e.g., v1.0.0, v1.2.3)

permissions:
  contents: write  # Required for creating releases

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build

      - name: Find JAR file
        id: find_jar
        run: |
          JAR_PATH=$(find build/libs -name "*.jar" -not -name "*-javadoc.jar" -not -name "*-sources.jar" | head -n 1)
          JAR_NAME=$(basename "$JAR_PATH")
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
          echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_NAME at $JAR_PATH"

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          name: Tiles to Pyramid Extension ${{ steps.get_version.outputs.version }}
          body: |
            ## QuPath Tiles to Pyramid Extension ${{ steps.get_version.outputs.version }}

            Stitches acquired microscope tiles into pyramidal OME-ZARR images for QuPath.

            ### Installation

            1. Download the JAR file below
            2. Place it in QuPath's `extensions` folder:
               - **Windows**: `C:\Users\YourName\QuPath\extensions\`
               - **macOS**: `~/QuPath/extensions/`
               - **Linux**: `~/QuPath/extensions/`
            3. Restart QuPath

            ### What's New

            See the [CHANGELOG](https://github.com/uw-loci/qupath-extension-tiles-to-pyramid/blob/main/CHANGELOG.md) for detailed release notes.

            ### Requirements

            - QuPath 0.6.0 or later
            - Java 21 or later

            ### Part of QPSC

            This extension is part of the [QPSC (QuPath Scope Control)](https://github.com/uw-loci/QPSC) system for annotation-driven microscopy acquisition.

            ### Installation Script

            For automated setup on Windows, use the [PPM-QuPath.ps1](https://github.com/uw-loci/QPSC/blob/main/PPM-QuPath.ps1) script.
          files: ${{ steps.find_jar.outputs.jar_path }}
          draft: false
          prerelease: false

      - name: Release Summary
        run: |
          echo "‚úÖ Release created/updated successfully!"
          echo "üì¶ Artifact: ${{ steps.find_jar.outputs.jar_name }}"
          echo "üè∑Ô∏è  Version: ${{ steps.get_version.outputs.version }}"
